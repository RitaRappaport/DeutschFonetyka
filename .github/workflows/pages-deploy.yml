name: Deploy (GitHub Pages â€” self-healing)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show repo tree (debug)
        run: |
          echo "Repo: $GITHUB_REPOSITORY"
          echo "Branch: $GITHUB_REF_NAME"
          ls -la
          echo "---- files end ----"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Try build (Vite/React)
        id: build
        shell: bash
        run: |
          set -e
          if [ -f package.json ]; then
            echo "package.json found â€“ trying install/build"
            if [ -f package-lock.json ]; then npm ci; else npm i; fi
            # build z tolerancjÄ…: najpierw skrypt, potem bezpoÅ›rednio vite
            (npm run build || npx vite build) || echo "BUILD_FAILED=1" >> $GITHUB_ENV
          else
            echo "NO_NODE=1" >> $GITHUB_ENV
          fi
        continue-on-error: true

      - name: Create FALLBACK if no dist
        if: ${{ !hashFiles('dist/**') }}
        shell: bash
        run: |
          set -e
          echo "No dist/ found. Creating fallback page."
          mkdir -p _pages_fallback
          cat > _pages_fallback/index.html <<'HTML'
<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DeutschFonetyka â€” fallback</title>
  <style>
    body{font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto;padding:24px;max-width:720px;margin:0 auto;}
    code{background:#f3f5f7;padding:2px 6px;border-radius:6px}
    .tag{display:inline-block;background:#eef7ff;border:1px solid #cde2ff;padding:2px 8px;border-radius:999px;margin-right:8px}
  </style>
</head>
<body>
  <h1>ğŸ”§ WdroÅ¼ono stronÄ™ â€” ale build aplikacji siÄ™ nie powiÃ³dÅ‚</h1>
  <p>To jest strona tymczasowa (fallback), Å¼eby <b>adres dziaÅ‚aÅ‚</b>. PoniÅ¼ej wskazÃ³wki co poprawiÄ‡.</p>
  <h2>Co sprawdziÄ‡ lokalnie</h2>
  <ol>
    <li>Uruchom w PowerShell: <code>npm ci</code> (albo <code>npm i</code>), potem <code>npx vite build</code>.</li>
    <li>JeÅ›li zobaczysz bÅ‚Ä…d parsera HTML: podmieÅ„ <code>index.html</code> na czysty plik Vite.</li>
    <li>Po poprawce: commit + push â€” workflow sam siÄ™ uruchomi i zastÄ…pi fallback wÅ‚aÅ›ciwÄ… aplikacjÄ….</li>
  </ol>
  <p class="tag">GitHub Pages: dziaÅ‚a</p>
  <p class="tag">Build app: do poprawy</p>
</body>
</html>
HTML

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact (dist or fallback)
        uses: actions/upload-pages-artifact@v3
        with:
          path: |
            dist
            _pages_fallback

  deploy:
    needs: build-and-upload
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    steps:
      - name: Deploy to Pages
        uses: actions/deploy-pages@v4
