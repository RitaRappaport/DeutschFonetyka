name: Deploy (GitHub Pages â€” self-healing)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Try build (Vite/React)
        id: build
        shell: bash
        run: |
          set -e
          if [ -f package.json ]; then
            if [ -f package-lock.json ]; then npm ci; else npm i; fi
            (npm run build || npx vite build) || echo "BUILD_FAILED=1" >> $GITHUB_ENV
          else
            echo "NO_NODE=1" >> $GITHUB_ENV
          fi
        continue-on-error: true

      - name: Create FALLBACK if no dist
        if: ${{ !hashFiles('dist/**') }}
        shell: bash
        run: |
          mkdir -p _pages_fallback
          cat > _pages_fallback/index.html <<'HTML'
<!doctype html>
<html lang="pl"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>DeutschFonetyka â€” fallback</title>
<style>body{font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto;padding:24px;max-width:720px;margin:0 auto;}code{background:#f3f5f7;padding:2px 6px;border-radius:6px}</style>
</head><body>
<h1>ğŸ”§ Strona dziaÅ‚a (fallback), ale build aplikacji siÄ™ nie powiÃ³dÅ‚</h1>
<p>SprawdÅº lokalnie: <code>npm ci</code> â†’ <code>npx vite build</code>. Po poprawce zrÃ³b push â€” ten fallback zostanie zastÄ…piony aplikacjÄ….</p>
</body></html>
HTML

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact (dist or fallback)
        uses: actions/upload-pages-artifact@v3
        with:
          path: |
            dist
            _pages_fallback

  deploy:
    needs: build-and-upload
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    steps:
      - name: Deploy to Pages
        uses: actions/deploy-pages@v4
